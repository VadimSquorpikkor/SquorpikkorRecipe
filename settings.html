<!DOCTYPE html>

<html lang="ru">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <meta charset="UTF-8">
    <title>TITLE</title>
    <link rel="stylesheet" type="text/css" href="reset.css">
    <link rel="stylesheet" type="text/css" href="utils_style.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
    <script type="text/javascript" src="style_func.js"></script>
</head>

<body>

<button onclick="topFunction()" id="myBtn" title="Go to top">Top</button>

<div>

    <h1>Settings</h1>

    <img src="imgs/a.jpg"/>

    <div class="nice_details">
        <details>
            <summary>SettingsActivity. Базовый код</summary>
            <pre>
                public class SettingsActivity extends AppCompatActivity {

                    @Override
                    protected void onCreate(Bundle savedInstanceState) {
                        super.onCreate(savedInstanceState);
                        setContentView(R.layout.settings_activity);

                        if (savedInstanceState == null) {
                            getSupportFragmentManager()
                                    .beginTransaction()
                                    .replace(R.id.settings, new SettingsFragment())
                                    .commit();
                        }
                        ActionBar actionBar = getSupportActionBar();
                        if (actionBar != null) {
                            actionBar.setDisplayHomeAsUpEnabled(true);
                        }
                    }

                    public static class SettingsFragment extends PreferenceFragmentCompat {
                        @Override
                        public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
                            setPreferencesFromResource(R.xml.root_preferences, rootKey);
                        }
                    }
            </pre>
            <pre>
            &lt;?xml version="1.0" encoding="utf-8"?>
            &lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android="http://schemas.android.com/apk/res/android"
                                                               xmlns:tools="http://schemas.android.com/tools"
                                                               android:layout_width="match_parent"
                                                               android:layout_height="match_parent"
                                                               tools:context=".MySettingsActivity">

            &lt;fragment android:layout_width="match_parent"
                          android:layout_height="match_parent"
                          android:id="@+id/container"/>

            &lt;/androidx.constraintlayout.widget.ConstraintLayout>
            </pre>

            <pre>
            &lt;PreferenceScreen
                    xmlns:app="http://schemas.android.com/apk/res-auto">

                &lt;SwitchPreferenceCompat
                        app:key="notifications"
                        app:title="Enable message notifications"/>

                &lt;Preference
                        app:key="feedback"
                        app:title="Send feedback"
                        app:summary="Report technical issues or suggest new features"/>

            &lt;/PreferenceScreen>
            </pre>
        </details>
    </div>

    <div class="nice_details">
        <details>
            <summary>отдельно можно задать тему для настроек(!)</summary>
            <pre>
    &lt;resources xmlns:tools="http://schemas.android.com/tools">
                <!-- Base application theme. -->
        &lt;style name="Theme.KursPoAndroid" parent="Theme.MaterialComponents.DayNight.DarkActionBar">
            //...
            <item name="preferenceTheme">@style/PreferenceThemeOverlay</item>
        &lt;/style>
    &lt;/resources>
    </pre>
        </details>
    </div>


    <div class="attention_block">если используется onSharedPreferenceListener, то при закрытии активити от него нужно отписаться (в onDestroy)</div>



    <div class="nice_details">
        <details>
            <summary>Отслеживать изменения настроек:</summary>

            <pre>
    public class MainActivity extends AppCompatActivity implements SharedPreferences.OnSharedPreferenceChangeListener {

    SharedPreferences preferences;

    @Override
    public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) {
        if (key.equals("имя_настройки")) setSomeValue(preferences);
    }

    private void setSomeValue(SharedPreferences preferences) {
        int value = Integer.valueOf(preferences.getString("имя_настройки", "default_value"));
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        preferences.unregisterOnSharedPreferenceChangeListener(this);
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        preferences = PreferenceManager.getDefaultSharedPreferences(this);
        preferences.registerOnSharedPreferenceChangeListener(this);
        //...
    }
    </pre>

        </details>
    </div>


    <div class="nice_details">
        <details>
            <summary>OnPreferencesChangeListener</summary>

            OnPreferencesChangeListener (не путать с OnSharedPreferencesChangeListener) отслеживает изменение конкретной
            настройки. Вызывается ДО ВЫЗОВА OnSharedPrChL
            <pre>
    public class MySettingsFragment extends PreferenceFragmentCompat implements Preference.OnPreferenceChangeListener {
    //...
    @Override
    public boolean onPreferenceChange(Preference preference, Object newValue) {
        return false;
    }
}
    </pre>
            если возвращает false, то это значение не будет сохранено в SharedPref
            Можно проверять введенные значения!:
            <pre>
    public class MySettingsFragment extends PreferenceFragmentCompat implements Preference.OnPreferenceChangeListener {
    @Override
    public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
        setPreferencesFromResource(R.xml.preferences, rootKey);
        Preference preference = findPreference("ключ_настройки");
        preference.setOnPreferenceChangeListener(this);
    }

    @Override
    public boolean onPreferenceChange(Preference preference, Object newValue) {
        //проверка: если было введено не число (а буквы например) то выведется лиалог или тост
        if (preference.getKey().equals("ключ_настройки")) {
            String s = (String) newValue;
            try {
                int def = Integer.parseInt(s);
            } catch (NumberFormatException e) {
                //выводим тост или диалог об ошибке
                return false;
            }
        }
        return true;
    }
}
    </pre>
            Мне больше нравится такое делать через анонимный класс (аккуратнее получается):
            <pre>
    public class MySettingsFragment extends PreferenceFragmentCompat {
        @Override
        public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
            setPreferencesFromResource(R.xml.preferences, rootKey);
            Preference preference = findPreference("ключ_настройки");
            preference.setOnPreferenceChangeListener((preference1, newValue) -> {
                //проверка: если было введено не число (а буквы например) то выведется лиалог или тост
                if (preference1.getKey().equals("ключ_настройки")) {
                    String s = (String) newValue;
                    try { int def = Integer.parseInt(s);
                    } catch (NumberFormatException e) {
                        //выводим тост или диалог об ошибке
                        return false;
                    }
                }
                return true;
            });
        }
    }
    </pre>
            А ещё лучше так (когда много настроек, можно сделать общие всякие проверки):
            <pre>
    public class MySettingsFragment extends PreferenceFragmentCompat {
        @Override
        public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
            setPreferencesFromResource(R.xml.preferences, rootKey);
            Preference preference = findPreference("ключ_настройки");
            preference.setOnPreferenceChangeListener((preference1, newValue) -> {
                //проверка: если было введено не число (а буквы например) то выведется лиалог или тост
                //тут будет switch case
                if (preference1.getKey().equals("ключ_настройки")) return checkInt(newValue);
                else return true;
            });
        }
        boolean checkInt(Object newValue) {
            String s = (String) newValue;
            try { int def = Integer.parseInt(s);
            } catch (NumberFormatException e) {
                //выводим тост или диалог об ошибке
                return false;
            }
            return true;
        }
    }
    </pre>

        </details>
    </div>
    <div class="nice_details">
        <details>
            <summary>Пример рабочей активности настроек:</summary>

            <pre>
    public class SettingsActivity extends AppCompatActivity {

        @Override
        protected void onCreate(Bundle savedInstanceState) {
            super.onCreate(savedInstanceState);
            ThemeUtils.onActivityCreateSetTheme(this);
            setContentView(R.layout.settings_activity);
            if (savedInstanceState == null) {
                getSupportFragmentManager()
                        .beginTransaction()
                        .replace(R.id.settings, new SettingsFragment())
                        .commit();
            }
            ActionBar actionBar = getSupportActionBar();
            if (actionBar != null) {
                actionBar.setDisplayHomeAsUpEnabled(true);
            }
        }

        public static class SettingsFragment extends PreferenceFragmentCompat {
            @Override
            public void onCreatePreferences(Bundle savedInstanceState, String rootKey) {
                setPreferencesFromResource(R.xml.root_preferences, rootKey);
                findPreference(getString(R.string.time_scanning_spectrometric)).setOnPreferenceChangeListener(listener);
                findPreference(getString(R.string.pref_atdr_address)).setOnPreferenceChangeListener(listener);
                findPreference(getString(R.string.time_scanning_radiometric)).setOnPreferenceChangeListener(listener);

                //переключение темы сделать нормально потом
                ListPreference switchUseCash = getPreferenceScreen().findPreference(PREF_THEME);
                assert switchUseCash != null;
                switchUseCash.setOnPreferenceChangeListener((preference, newValue) -> {
                    int i = Integer.parseInt((String)newValue);
                    ThemeUtils.changeToThemePref(requireActivity(), i);
                    return true;
                });
                ThemeUtils.onActivityCreateSetTheme(getActivity());
            }

            Preference.OnPreferenceChangeListener listener = (preference, newValue) -> {
                if      (preference.getKey().equals(getString(R.string.time_scanning_spectrometric))) return checkIntInRange(newValue, 5, 300);
                else if (preference.getKey().equals(getString(R.string.pref_atdr_address))) return checkHex(newValue);
                else if (preference.getKey().equals(getString(R.string.time_scanning_radiometric))) return checkIntInRange(newValue, 5, 120);
                return true;
            };

            /**проверка: если было введено не число (а буквы например) то выведется лиалог или тост*/
            boolean checkInt(Object newValue) {
                String s = (String) newValue;
                //если ввести "1", вернет true, если "А", то сработает исключение и вернется false
                try { int def = Integer.parseInt(s);
                } catch (NumberFormatException e) {
                    //выводим тост или диалог об ошибке
                    Toast.makeText(requireActivity(), getString(R.string.wrong_param), Toast.LENGTH_SHORT).show();
                    return false;
                }
                return true;
            }

            /**Новое значение должно быть integer и в диапазоне min-max*/
            boolean checkIntInRange(Object newValue, int min, int max) {
                if (!checkInt(newValue)) return false;
                int i = Integer.parseInt((String)newValue);
                if (i < min) {
                    Toast.makeText(requireActivity(), String.format(getString(R.string.should_be_more_than), min), Toast.LENGTH_SHORT).show();
                    return false;
                }
                if (i > max) {
                    Toast.makeText(requireActivity(), String.format(getString(R.string.should_be_more_less), max), Toast.LENGTH_SHORT).show();
                    return false;
                }
                return true;
            }

            /**Проверка HEX: значения вида "50" или "FF" — корректны; числа должны быть в диапазоне 0-FF*/
            boolean checkHex(Object newValue) {
                String hex = (String) newValue;
                try {
                    int i = Integer.parseInt(hex, 16);
                    if (i<0||i>255) throw new NumberFormatException();
                } catch (NumberFormatException e) {
                    //выводим тост или диалог об ошибке
                    Toast.makeText(requireActivity(), getString(R.string.wrong_param), Toast.LENGTH_SHORT).show();
                    return false;
                }
                return true;
            }
        }
    }
    </pre>
            xml:
            <pre>
    &lt;PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android"
                      xmlns:app="http://schemas.android.com/apk/res-auto">

        &lt;PreferenceCategory app:title="@string/set_appearance">

                <!--            android:layout="@layout/mylayout"  использовать кастомный стиль-->
            &lt;ListPreference
                    app:defaultValue="3"
                    app:entries="@array/themes_entries"
                    app:entryValues="@array/themes_values"
                    app:key="theme"
                    app:title="@string/theme_title"
                    app:useSimpleSummaryProvider="true" />


        &lt;/PreferenceCategory>

        &lt;PreferenceCategory app:title="@string/set_misc">

            &lt;EditTextPreference
                    android:defaultValue="@string/default_pref_atdr_address"
                    app:key="@string/pref_atdr_address"
                    app:title="@string/set_atdr_address"
                    app:useSimpleSummaryProvider="true" />

            &lt;EditTextPreference
                    android:defaultValue="@string/default_pref_spectrometric_time"
                    app:key="@string/time_scanning_spectrometric"
                    app:title="@string/time_scanning_spectrometric_title"
                    app:useSimpleSummaryProvider="true" />

            &lt;EditTextPreference
                    android:defaultValue="@string/default_pref_radiometric_time"
                    app:key="@string/time_scanning_radiometric"
                    app:title="@string/time_scanning_radiometric_title"
                    app:useSimpleSummaryProvider="true" />

            &lt;SwitchPreferenceCompat
                    android:defaultValue="false"
                    app:key="@string/pref_start_session"
                    app:summaryOff="@string/set_manual_start_session"
                    app:summaryOn="@string/set_auto_start_session"
                    app:title="@string/set_auto_start_session_title" />

            &lt;SwitchPreferenceCompat
                    android:defaultValue="true"
                    app:key="@string/pref_ask_stabilization"
                    app:summaryOff="@string/set_do_not_ask"
                    app:summaryOn="@string/set_ask_on_start"
                    app:title="@string/set_ask_for_stabilization" />

            &lt;SwitchPreferenceCompat
                    android:defaultValue="@string/default_pref_show_measuring"
                    app:key="@string/pref_show_measuring"
                    app:summaryOff="@string/set_do_not_show"
                    app:summaryOn="@string/set_show"
                    app:title="@string/set_show_measuring" />

        &lt;/PreferenceCategory>
    &lt;/PreferenceScreen>
    </pre>

            <pre>
    &lt;resources>
        &lt;string-array name="themes_entries">
            &lt;item>@string/light_theme&lt;/item>
            &lt;item>@string/gray_theme&lt;/item>
            &lt;item>@string/dark_theme&lt;/item>
            &lt;item>@string/dark_theme_2&lt;/item>
        &lt;/string-array>

        &lt;string-array name="themes_values">
            &lt;item>1&lt;/item>
            &lt;item>2&lt;/item>
            &lt;item>3&lt;/item>
            &lt;item>4&lt;/item>
        &lt;/string-array>
    &lt;/resources>
    </pre>

            <pre>
    &lt;string name="wrong_param">Некоректное значение!&lt;/string>
    &lt;string name="should_be_more_than">Число должно быть болше %d&lt;/string>
    &lt;string name="should_be_more_less">Число должно быть меньше %d</string>
    </pre>

        </details>
    </div>


</div>
</body>
</html>